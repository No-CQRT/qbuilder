<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bing Query Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"> 

<style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            max-width: 800px;
        }
        .form-control, .form-select {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        .form-control::placeholder {
            color: #aaa;
        }
        .form-control:focus, .form-select:focus {
            background-color: #444;
            color: #fff;
            border-color: #666;
            box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25);
        }
        .btn-primary {
            background-color: #4a90e2;
            border-color: #4a90e2;
        }
        .btn-primary:hover {
            background-color: #357bd2;
            border-color: #357bd2;
        }
        .card {
            background-color: #1e1e1e;
            border-color: #333;
        }
        .card-header {
            background-color: #2c2c2c;
            border-color: #333;
        }
        .form-label, .form-check-label {
            color: #b0b0b0;
        }
        h1 {
            color: #b0b0b0;
        }
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        .site-badge {
            display: inline-flex;
            align-items: center;
            background-color: #4a90e2;
            color: white;
            padding: .35em .65em;
            border-radius: .375rem;
            margin-right: .5rem;
            margin-bottom: .5rem;
            font-size: .875em;
        }
        .site-badge .remove-site {
            margin-left: .5em;
            cursor: pointer;
            font-size: 1.1em;
            line-height: 1;
        }
        .site-list {
            margin-top: .5rem;
            min-height: 38px;
            border: 1px solid #555;
            border-radius: .375rem;
            padding: .5rem;
            background-color: #333;
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <div class="card p-4">
            <div class="card-header text-center mb-4">
                <h1 class="mb-0">Bing Query Builder</h1>
            </div>
            <form id="queryForm">
                <div class="mb-3">
                    <label for="keywords" class="form-label">Parole chiave (separate da virgola):</label>
                    <input type="text" class="form-control" id="keywords" placeholder="es: intelligenza artificiale, machine learning">
                </div>
                
                <div class="mb-3">
                    <label for="exactPhrase" class="form-label">Frase esatta:</label>
                    <input type="text" class="form-control" id="exactPhrase" placeholder="es: 'nuove scoperte scientifiche'">
                </div>
                
                <div class="mb-3">
                    <label for="excludeWords" class="form-label">Parole da escludere (separate da virgola):</label>
                    <input type="text" class="form-control" id="excludeWords" placeholder="es: -prezzo, -costo">
                </div>
                
                <div class="mb-3">
                    <label for="filetype" class="form-label">Formato file (filetype:):</label>
                    <select class="form-select" id="filetype">
                        <option value="">Nessuno</option>
                        <option value="pdf">PDF</option>
                        <option value="doc">DOC</option>
                        <option value="docx">DOCX</option>
                        <option value="ppt">PPT</option>
                        <option value="pptx">PPTX</option>
                        <option value="xls">XLS</option>
                        <option value="xlsx">XLSX</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="siteIncludeInput" class="form-label">Siti da includere (site:):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="siteIncludeInput" placeholder="es: wikipedia.org">
                        <button class="btn btn-primary" type="button" id="addSiteIncludeBtn"><i class="bi bi-plus-lg"></i></button>
                    </div>
                    <div id="siteIncludeList" class="site-list d-flex flex-wrap align-items-center"></div>
                </div>

                <div class="mb-3">
                    <label for="siteExcludeInput" class="form-label">Siti da escludere (-site:):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="siteExcludeInput" placeholder="es: pinterest.com">
                        <button class="btn btn-primary" type="button" id="addSiteExcludeBtn"><i class="bi bi-plus-lg"></i></button>
                    </div>
                    <div id="siteExcludeList" class="site-list d-flex flex-wrap align-items-center"></div>
                </div>

                <div class="mb-3">
                    <label for="keywordsLocation" class="form-label">I termini devono apparire:</label>
                    <select class="form-select" id="keywordsLocation">
                        <option value="">In qualsiasi punto</option>
                        <option value="intitle">Nel titolo della pagina</option>
                        <option value="inurl">Nell'URL della pagina</option>
                        </select>
                </div>
                
                <div class="mb-4 form-check">
                    <input class="form-check-input" type="checkbox" id="imageSearch">
                    <label class="form-check-label" for="imageSearch">Cerca immagini</label>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">Cerca su Bing</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.getElementById('queryForm');
        const keywords = document.getElementById('keywords');
        const exactPhrase = document.getElementById('exactPhrase');
        const excludeWords = document.getElementById('excludeWords');
        const filetype = document.getElementById('filetype');
        
        const siteIncludeInput = document.getElementById('siteIncludeInput');
        const addSiteIncludeBtn = document.getElementById('addSiteIncludeBtn');
        const siteIncludeListDiv = document.getElementById('siteIncludeList');
        let includedSites = [];

        const siteExcludeInput = document.getElementById('siteExcludeInput');
        const addSiteExcludeBtn = document.getElementById('addSiteExcludeBtn');
        const siteExcludeListDiv = document.getElementById('siteExcludeList');
        let excludedSites = [];

        const keywordsLocation = document.getElementById('keywordsLocation');
        const imageSearch = document.getElementById('imageSearch');
        
        function createSiteBadge(site, listArray, listDiv) {
            const siteText = site.trim();
            if (siteText === '') return;

            const badge = document.createElement('span');
            badge.classList.add('site-badge');
            badge.textContent = siteText;
            
            const removeBtn = document.createElement('i');
            removeBtn.classList.add('bi', 'bi-x-lg', 'remove-site');
            removeBtn.addEventListener('click', () => {
                const index = listArray.indexOf(siteText);
                if (index > -1) {
                    listArray.splice(index, 1);
                    listDiv.removeChild(badge);
                    saveStateToLocalStorage();
                }
            });
            
            badge.appendChild(removeBtn);
            listDiv.appendChild(badge);
            
            if (!listArray.includes(siteText)) {
                listArray.push(siteText);
            }
        }

        function populateSiteList(listArray, listDiv) {
            listDiv.innerHTML = '';
            listArray.forEach(site => {
                createSiteBadge(site, listArray, listDiv);
            });
        }

        addSiteIncludeBtn.addEventListener('click', () => {
            const site = siteIncludeInput.value.trim();
            if (site && !includedSites.includes(site)) {
                createSiteBadge(site, includedSites, siteIncludeListDiv);
                siteIncludeInput.value = '';
                saveStateToLocalStorage();
            }
        });
        siteIncludeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSiteIncludeBtn.click();
            }
        });

        addSiteExcludeBtn.addEventListener('click', () => {
            const site = siteExcludeInput.value.trim();
            if (site && !excludedSites.includes(site)) {
                createSiteBadge(site, excludedSites, siteExcludeListDiv);
                siteExcludeInput.value = '';
                saveStateToLocalStorage();
            }
        });
        siteExcludeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSiteExcludeBtn.click();
            }
        });
        
        keywordsLocation.addEventListener('change', saveStateToLocalStorage);
        imageSearch.addEventListener('change', saveStateToLocalStorage); // Aggiunto per salvare lo stato della checkbox

        function saveStateToLocalStorage() {
            const currentState = {
                keywords: keywords.value,
                exactPhrase: exactPhrase.value,
                excludeWords: excludeWords.value,
                filetype: filetype.value,
                includedSites: includedSites,
                excludedSites: excludedSites,
                keywordsLocation: keywordsLocation.value,
                imageSearch: imageSearch.checked
            };
            localStorage.setItem('bingQueryBuilderState', JSON.stringify(currentState)); // Cambiato il nome della chiave
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedState = localStorage.getItem('bingQueryBuilderState'); // Cambiato il nome della chiave
            if (savedState) {
                const state = JSON.parse(savedState);
                keywords.value = state.keywords || '';
                exactPhrase.value = state.exactPhrase || '';
                excludeWords.value = state.excludeWords || '';
                filetype.value = state.filetype || '';
                
                includedSites = state.includedSites || [];
                excludedSites = state.excludedSites || [];
                populateSiteList(includedSites, siteIncludeListDiv);
                populateSiteList(excludedSites, siteExcludeListDiv);

                keywordsLocation.value = state.keywordsLocation || '';
                imageSearch.checked = state.imageSearch || false;
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            saveStateToLocalStorage();
            
            let queryParts = [];
            let mainQueryTerms = []; // Usiamo un array per i termini principali (keywords, exact, exclude)

            // Aggiungi parole chiave
            const keywordsValue = keywords.value.trim();
            if (keywordsValue !== '') {
                mainQueryTerms.push(...keywordsValue.split(',').map(kw => kw.trim()));
            }

            // Aggiungi frase esatta
            if (exactPhrase.value.trim() !== '') {
                mainQueryTerms.push(`"${exactPhrase.value.trim()}"`);
            }

            // Aggiungi parole da escludere
            if (excludeWords.value.trim() !== '') {
                mainQueryTerms.push(...excludeWords.value.split(',').map(ew => `-${ew.trim()}`));
            }

            // Applica la posizione dei termini (intitle, inurl)
            const locationPrefix = keywordsLocation.value;
            if (locationPrefix !== '') {
                // Bing, come DDG, tende ad applicare intitle/inurl a ogni termine separatamente
                const processedTerms = mainQueryTerms.map(term => {
                    if (term.startsWith('-') || (term.startsWith('"') && term.endsWith('"'))) {
                        return term; // Non applicare il prefisso a operatori già esistenti
                    }
                    return `${locationPrefix}:${term}`;
                });
                queryParts.push(...processedTerms);
            } else {
                queryParts.push(...mainQueryTerms);
            }

            // Aggiungi filetype (Bing supporta filetype:)
            if (filetype.value !== '') {
                queryParts.push(`filetype:${filetype.value}`);
            }

            // Aggiungi siti da includere (site: funziona uguale)
            if (includedSites.length > 0) {
                queryParts.push(includedSites.map(site => `site:${site}`).join(' '));
            }

            // Aggiungi siti da escludere (-site: funziona uguale)
            if (excludedSites.length > 0) {
                queryParts.push(excludedSites.map(site => `-site:${site}`).join(' '));
            }
            
            const finalQuery = queryParts.join(' ').trim();
            
            let baseUrl = 'https://www.bing.com/search?q=';
            if (imageSearch.checked) {
                baseUrl = 'https://www.bing.com/images/search?q='; // URL specifico per la ricerca immagini di Bing
            }
            
            const url = `${baseUrl}${encodeURIComponent(finalQuery)}`;

            if (finalQuery) {
                window.open(url, '_blank');
            } else {
                alert("La query è vuota! Inserisci almeno una parola chiave o un sito.");
            }
        });
    </script>
</body>
</html>
