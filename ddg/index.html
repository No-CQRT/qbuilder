<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDG Query Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"> 

<style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            max-width: 800px;
        }
        .form-control, .form-select, .form-range {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        .form-control::placeholder {
            color: #aaa;
        }
        .form-control:focus, .form-select:focus, .form-range:focus {
            background-color: #444;
            color: #fff;
            border-color: #666;
            box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25);
        }
        .btn-primary {
            background-color: #4a90e2;
            border-color: #4a90e2;
        }
        .btn-primary:hover {
            background-color: #357bd2;
            border-color: #357bd2;
        }
        .card {
            background-color: #1e1e1e;
            border-color: #333;
        }
        .card-header {
            background-color: #2c2c2c;
            border-color: #333;
        }
        .form-label, .form-check-label, #timeRangeValue {
            color: #b0b0b0;
        }
        h1 {
            color: #b0b0b0;
        }
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        .site-badge {
            display: inline-flex;
            align-items: center;
            background-color: #4a90e2;
            color: white;
            padding: .35em .65em;
            border-radius: .375rem;
            margin-right: .5rem;
            margin-bottom: .5rem;
            font-size: .875em;
        }
        .site-badge .remove-site {
            margin-left: .5em;
            cursor: pointer;
            font-size: 1.1em;
            line-height: 1;
        }
        .site-list {
            margin-top: .5rem;
            min-height: 38px;
            border: 1px solid #555;
            border-radius: .375rem;
            padding: .5rem;
            background-color: #333;
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <div class="card p-4">
            <div class="card-header text-center mb-4">
                <h1 class="mb-0">DDG Query Builder</h1>
            </div>
            <form id="queryForm">
                <div class="mb-3">
                    <label for="keywords" class="form-label">Parole chiave (separate da virgola):</label>
                    <input type="text" class="form-control" id="keywords" placeholder="es: intelligenza artificiale, machine learning">
                </div>
                
                <div class="mb-3">
                    <label for="exactPhrase" class="form-label">Frase esatta:</label>
                    <input type="text" class="form-control" id="exactPhrase" placeholder="es: 'nuove scoperte scientifiche'">
                </div>
                
                <div class="mb-3">
                    <label for="excludeWords" class="form-label">Parole da escludere (separate da virgola):</label>
                    <input type="text" class="form-control" id="excludeWords" placeholder="es: -prezzo, -costo">
                </div>
                
                <div class="mb-3">
                    <label for="filetype" class="form-label">Formato file (filetype:):</label>
                    <select class="form-select" id="filetype">
                        <option value="">Nessuno</option>
                        <option value="pdf">PDF</option>
                        <option value="doc">DOC</option>
                        <option value="docx">DOCX</option>
                        <option value="ppt">PPT</option>
                        <option value="pptx">PPTX</option>
                        <option value="xls">XLS</option>
                        <option value="xlsx">XLSX</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="siteIncludeInput" class="form-label">Siti da includere (site:):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="siteIncludeInput" placeholder="es: wikipedia.org">
                        <button class="btn btn-primary" type="button" id="addSiteIncludeBtn"><i class="bi bi-plus-lg"></i></button>
                    </div>
                    <div id="siteIncludeList" class="site-list d-flex flex-wrap align-items-center"></div>
                </div>

                <div class="mb-3">
                    <label for="siteExcludeInput" class="form-label">Siti da escludere (-site:):</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="siteExcludeInput" placeholder="es: pinterest.com">
                        <button class="btn btn-primary" type="button" id="addSiteExcludeBtn"><i class="bi bi-plus-lg"></i></button>
                    </div>
                    <div id="siteExcludeList" class="site-list d-flex flex-wrap align-items-center"></div>
                </div>

                <div class="mb-3">
                    <label for="keywordsLocation" class="form-label">I termini devono apparire:</label>
                    <select class="form-select" id="keywordsLocation">
                        <option value="">In qualsiasi punto</option>
                        <option value="intitle">Nel titolo della pagina</option>
                        <option value="inurl">Nell'URL della pagina</option>
                        </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Numeri compresi tra:</label>
                    <div class="row g-2">
                        <div class="col">
                            <input type="number" class="form-control" id="numberRangeFrom" placeholder="Da">
                        </div>
                        <div class="col-auto d-flex align-items-center" style="color: #b0b0b0;">
                            ...
                        </div>
                        <div class="col">
                            <input type="number" class="form-control" id="numberRangeTo" placeholder="A">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="timeRange" class="form-label">Intervallo di tempo:</label>
                    <input type="range" class="form-range" id="timeRange" min="0" max="4" value="0">
                    <span id="timeRangeValue" class="d-block mt-2 text-center">Nessuno</span>
                    <small class="form-text text-muted" style="color: #888 !important;">
                        Nota: DuckDuckGo ha un supporto limitato per i filtri di tempo esatti tramite URL. Verrà applicato un filtro generico.
                    </small>
                </div>
                
                <div class="mb-4 form-check">
                    <input class="form-check-input" type="checkbox" id="imageSearch">
                    <label class="form-check-label" for="imageSearch">Cerca immagini</label>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">Cerca su DuckDuckGo</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.getElementById('queryForm');
        const keywords = document.getElementById('keywords');
        const exactPhrase = document.getElementById('exactPhrase');
        const excludeWords = document.getElementById('excludeWords');
        const filetype = document.getElementById('filetype');
        
        const siteIncludeInput = document.getElementById('siteIncludeInput');
        const addSiteIncludeBtn = document.getElementById('addSiteIncludeBtn');
        const siteIncludeListDiv = document.getElementById('siteIncludeList');
        let includedSites = [];

        const siteExcludeInput = document.getElementById('siteExcludeInput');
        const addSiteExcludeBtn = document.getElementById('addSiteExcludeBtn');
        const siteExcludeListDiv = document.getElementById('siteExcludeList');
        let excludedSites = [];

        const keywordsLocation = document.getElementById('keywordsLocation');
        const numberRangeFrom = document.getElementById('numberRangeFrom');
        const numberRangeTo = document.getElementById('numberRangeTo');

        const timeRange = document.getElementById('timeRange');
        const imageSearch = document.getElementById('imageSearch');
        const timeRangeValue = document.getElementById('timeRangeValue');
        
        const timeRanges = ['Nessuno', 'Ultimi 24 ore', 'Ultima settimana', 'Ultimo mese', 'Ultimo anno'];

        timeRange.addEventListener('input', () => {
            timeRangeValue.textContent = timeRanges[timeRange.value];
        });

        function createSiteBadge(site, listArray, listDiv) {
            const siteText = site.trim();
            if (siteText === '') return;

            const badge = document.createElement('span');
            badge.classList.add('site-badge');
            badge.textContent = siteText;
            
            const removeBtn = document.createElement('i');
            removeBtn.classList.add('bi', 'bi-x-lg', 'remove-site');
            removeBtn.addEventListener('click', () => {
                const index = listArray.indexOf(siteText);
                if (index > -1) {
                    listArray.splice(index, 1);
                    listDiv.removeChild(badge);
                    saveStateToLocalStorage();
                }
            });
            
            badge.appendChild(removeBtn);
            listDiv.appendChild(badge);
            
            if (!listArray.includes(siteText)) {
                listArray.push(siteText);
            }
        }

        function populateSiteList(listArray, listDiv) {
            listDiv.innerHTML = '';
            listArray.forEach(site => {
                createSiteBadge(site, listArray, listDiv);
            });
        }

        addSiteIncludeBtn.addEventListener('click', () => {
            const site = siteIncludeInput.value.trim();
            if (site && !includedSites.includes(site)) {
                createSiteBadge(site, includedSites, siteIncludeListDiv);
                siteIncludeInput.value = '';
                saveStateToLocalStorage();
            }
        });
        siteIncludeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSiteIncludeBtn.click();
            }
        });

        addSiteExcludeBtn.addEventListener('click', () => {
            const site = siteExcludeInput.value.trim();
            if (site && !excludedSites.includes(site)) {
                createSiteBadge(site, excludedSites, siteExcludeListDiv);
                siteExcludeInput.value = '';
                saveStateToLocalStorage();
            }
        });
        siteExcludeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSiteExcludeBtn.click();
            }
        });
        
        numberRangeFrom.addEventListener('input', saveStateToLocalStorage);
        numberRangeTo.addEventListener('input', saveStateToLocalStorage);
        keywordsLocation.addEventListener('change', saveStateToLocalStorage);

        function saveStateToLocalStorage() {
            const currentState = {
                keywords: keywords.value,
                exactPhrase: exactPhrase.value,
                excludeWords: excludeWords.value,
                filetype: filetype.value,
                includedSites: includedSites,
                excludedSites: excludedSites,
                keywordsLocation: keywordsLocation.value,
                numberRangeFrom: numberRangeFrom.value,
                numberRangeTo: numberRangeTo.value,
                timeRange: timeRange.value,
                imageSearch: imageSearch.checked
            };
            localStorage.setItem('ddgQueryBuilderState', JSON.stringify(currentState)); // Cambiato il nome della chiave
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedState = localStorage.getItem('ddgQueryBuilderState'); // Cambiato il nome della chiave
            if (savedState) {
                const state = JSON.parse(savedState);
                keywords.value = state.keywords || '';
                exactPhrase.value = state.exactPhrase || '';
                excludeWords.value = state.excludeWords || '';
                filetype.value = state.filetype || '';
                
                includedSites = state.includedSites || [];
                excludedSites = state.excludedSites || [];
                populateSiteList(includedSites, siteIncludeListDiv);
                populateSiteList(excludedSites, siteExcludeListDiv);

                keywordsLocation.value = state.keywordsLocation || '';
                numberRangeFrom.value = state.numberRangeFrom || '';
                numberRangeTo.value = state.numberRangeTo || '';

                timeRange.value = state.timeRange || '0';
                imageSearch.checked = state.imageSearch || false;
                timeRangeValue.textContent = timeRanges[timeRange.value];
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            saveStateToLocalStorage();
            
            let queryParts = [];
            let mainQueryKeywords = [];

            // Gestione delle parole chiave e della loro posizione
            const keywordsValue = keywords.value.trim();
            if (keywordsValue !== '') {
                mainQueryKeywords.push(...keywordsValue.split(',').map(kw => kw.trim()));
            }

            // Aggiungi frase esatta
            if (exactPhrase.value.trim() !== '') {
                mainQueryKeywords.push(`"${exactPhrase.value.trim()}"`);
            }

            // Aggiungi parole da escludere
            if (excludeWords.value.trim() !== '') {
                mainQueryKeywords.push(...excludeWords.value.split(',').map(ew => `-${ew.trim()}`));
            }

            // Seleziona dove devono apparire i termini
            const locationPrefix = keywordsLocation.value;
            if (locationPrefix !== '') {
                 // DuckDuckGo applica inurl/intitle a ogni parola singolarmente, non a tutte le keywords insieme come allinurl/allintitle di Google
                 // Quindi applichiamo il prefisso a ogni parola chiave principale (non frase esatta o esclusione)
                const processedKeywords = mainQueryKeywords.map(term => {
                    // Controlla se è già un operatore (es. -parola, "frase")
                    if (term.startsWith('-') || term.startsWith('"') && term.endsWith('"')) {
                        return term;
                    }
                    return `${locationPrefix}:${term}`;
                });
                queryParts.push(...processedKeywords);
            } else {
                queryParts.push(...mainQueryKeywords);
            }

            // Add filetype (DuckDuckGo supporta filetype: ma a volte è meno robusto di Google)
            if (filetype.value !== '') {
                queryParts.push(`filetype:${filetype.value}`);
            }

            // Add included sites (site: funziona uguale)
            if (includedSites.length > 0) {
                queryParts.push(includedSites.map(site => `site:${site}`).join(' '));
            }

            // Add excluded sites (-site: funziona uguale)
            if (excludedSites.length > 0) {
                queryParts.push(excludedSites.map(site => `-site:${site}`).join(' '));
            }

            // Add number range (funziona uguale: 100..200)
            if (numberRangeFrom.value !== '' && numberRangeTo.value !== '') {
                queryParts.push(`${numberRangeFrom.value}..${numberRangeTo.value}`);
            }
            
            const finalQuery = queryParts.join(' ').trim();
            
            let timeParam = '';
            // DuckDuckGo non ha un parametro URL robusto come as_qdr di Google per il filtro temporale esatto.
            // Possiamo provare a usare un parametro generico se presente, o semplicemente ignorarlo.
            // Per ora, lo ignoriamo o lasciamo come commento dato il supporto limitato.
            // if (timeRange.value !== '0') {
            //     timeParam = '&t=d'; // Questo è un esempio generico, ma DDG spesso non lo rispetta come Google
            // }

            let baseUrl = 'https://duckduckgo.com/?q=';
            if (imageSearch.checked) {
                baseUrl = 'https://duckduckgo.com/?q=images+'; // DuckDuckGo spesso richiede "images" nella query per la ricerca di immagini
            }
            
            const url = `${baseUrl}${encodeURIComponent(finalQuery)}`; // Rimosso timeParam, vedere nota sopra

            if (finalQuery) {
                window.open(url, '_blank');
            } else {
                alert("La query è vuota! Inserisci almeno una parola chiave o un sito.");
            }
        });
    </script>
</body>
</html>
